name: CI/CD for Main and Develop
on:
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - .github/workflows/**

  pull_request:
    branches:
      - main
      - dev
    paths-ignore:
      - .github/workflows/**

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
    - name: checkGitRepo
      uses: actions/checkout@v5
      with:
        repository: GuanTing-SMAX/argoCD-test
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        path: ./argoCD-test             

    - name: update file
      run: |
        VALUES_FILE="./argoCD-test/values.yaml"
        yq e ".image.tag = \"${{ github.sha }}\"" -i "$VALUES_FILE"

    - name: git add and push commit 
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
      run: |
        cd argoCD-test
        git config --global user.email "guanting@hismax.onmicrosoft.com"
        git config --global user.name "github-actions"

        git add .
        git commit -m "Update image tag to ${{ github.sha }}" || echo "No changes to commit"
        git push origin main
