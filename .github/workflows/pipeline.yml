name: CI/CD for Main and Develop
on:
  push:
    branches:
      - main
      - dev
    paths-ignore:
      - .github/workflows/**

  pull_request:
    branches:
      - main
      - dev
    paths-ignore:
      - .github/workflows/**

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
    - name: checkGitRepo
      uses: actions/checkout@v5
      with:
        repository: GuanTing-SMAX/argoCD-test
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        path: ./argoCD-test             

    - name: update file
      run: |
        FILE_PATH="./argoCD-test/templates/deployments/demo-backend.yaml"
        echo "Updating image tag to latest ..."
        sed -i 's|\(guanting0609/redis-sentinel-test:\).*|\1latest|' "$FILE_PATH"

    - name: git add and push commit 
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
      run: |
        cd argoCD-test
        git config --global user.email "guanting@hismax.onmicrosoft.com"
        git config --global user.name "github-actions"

        git add .
         git commit -m "Update image tag For Test"
        git push origin main
